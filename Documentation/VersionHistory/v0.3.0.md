# v0.3.0 - 아바타 런타임 교체, 자막 텍스트 전달, SDK 업데이트

**릴리스 날짜**: 2026-02-24

## 주요 변경사항

### 1. 아바타 런타임 교체 기능

Flutter에서 10개 아바타 프리팹 중 하나를 선택하여 런타임에 교체하는 기능을 구현했습니다.

- **AvatarEntry 매핑**: Inspector에서 아바타 ID ↔ 프리팹 매핑 설정
- **ChangeAvatar(avatarId)**: 기존 아바타 제거 → 새 프리팹 인스턴스화 → SDK 재연결
- **GetAvatarList()**: 사용 가능한 아바타 목록 및 현재 아바타 ID 조회
- **안전한 교체 흐름**: UnregisterCallbacks → StopTalkMotion → ClearCache → Destroy → Instantiate → RegisterCallbacks
- **SetLookTarget 자동 설정**: 새 아바타의 FluentTAvatarControllerFloatingHead에 카메라 look-at 자동 연결

#### 지원 아바타 (10종)

| ID | 프리팹 |
|---|---|
| sangjun | 260107_sangjun_rig |
| seokhee | 260107_seokhee_rig |
| taerin | 260107_taerin_rig |
| new01~new07 | 260107_new01_rig ~ 260107_new07_rig |

### 2. 자막 텍스트 전달 기능

PrepareAudio 요청에 자막 텍스트를 함께 전달하여 클라이언트 감정 태깅이 동작하도록 했습니다.

- **PrepareRequest.text 필드 추가**: C# 브릿지에서 텍스트를 SDK의 `PrepareSpeechMotion(clip, text, options)`로 전달
- **Flutter UI**: 멀티라인 텍스트 입력 필드 추가
- **Dart 브릿지**: `prepareAudio(url, {text})` 옵셔널 파라미터 추가

### 3. SDK 및 Unity 에셋 업데이트

- FluentT TalkMotion SDK 업데이트 (클라이언트 감정 태깅 지원)
- Avatar Controller Sample (Floating Head) v0.1.8 적용
  - 멀티 Idle 애니메이션 시스템
  - Override 클립 네이밍 정리 (`*_dummy` → `*_override`)
- 아바타 프리팹 수정 및 씬 재구성
- 애니메이션 정리 및 최적화

### 4. Flutter 테스트앱 UI 개선

- **아바타 선택 UI**: ChoiceChip 기반 아바타 선택기 (새로고침 버튼 포함)
- **Fallback 목록**: Unity Inspector 미설정 시에도 테스트 가능한 하드코딩 아바타 ID 목록
- **자막 텍스트 입력 필드**: Generate 버튼 위에 멀티라인 입력 추가

## 수정 파일

### Unity
- `unity/Assets/Scripts/FirsthabitWebGLBridge.cs` — AvatarEntry, ChangeAvatar, GetAvatarList, PrepareRequest.text 추가
- `unity/Assets/Plugins/WebGL/FirsthabitBridgePlugin.jslib` — FH_OnAvatarChanged, FH_OnAvatarList 추가
- Unity 에셋: 아바타 프리팹 10종, 애니메이션 클립, 씬 파일 업데이트

### Flutter
- `flutter_test_app/web/index.html` — onAvatarChanged, onAvatarList 콜백 추가
- `flutter_test_app/lib/unity_bridge.dart` — 아바타/자막 관련 Stream, 메서드 추가
- `flutter_test_app/lib/main.dart` — 아바타 선택 UI, 자막 입력 필드 추가

### 문서
- `CLAUDE.md` — 버전 히스토리 규칙 추가, 남은 과제 목록 업데이트

## 커밋 이력

- `9e85876` - SDK 업데이트, 클라이언트 감정 태깅 적용 및 애니메이션 최적화
- `660df6c` - Unity 에셋 업데이트 - 애니메이션 정리, 아바타 프리팹 수정, 씬 재구성
- `8aab07b` - 아바타 런타임 교체 기능 및 자막 텍스트 전달 구현

## 하위 호환성

- 기존 Flutter 브릿지 API는 모두 유지 (prepareAudio의 text 파라미터는 옵셔널)
- Unity Inspector에서 avatarEntries 미설정 시 기존 단일 아바타로 동작
- ChangeAvatar 콜백 미등록 시에도 교체 동작은 정상 수행
